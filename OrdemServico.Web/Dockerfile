# ===============================
# üèóÔ∏è STAGE 1: Build do Front-End (React)
# ===============================
FROM node:20 AS frontend-build
WORKDIR /src

# Copia package.json e instala depend√™ncias
COPY OrdemServico.Web/ClientApp/package*.json ./ClientApp/
WORKDIR /src/ClientApp
RUN npm install

# Copia o restante e faz build
COPY OrdemServico.Web/ClientApp ./
RUN npm run build --omit=dev || true  # ignora erro do "move"
RUN cp -r build /src/wwwroot

# ===============================
# ‚öôÔ∏è STAGE 2: Build do Back-End (.NET)
# ===============================
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copia arquivos de projeto e restaura depend√™ncias
COPY OrdemServico.sln .
COPY Bussiness/Bussiness.csproj Bussiness/
COPY Domain/Domain.csproj Domain/
COPY Infra/Infra.csproj Infra/
COPY OrdemServico/OrdemServico.csproj OrdemServico/
COPY OrdemServico.Web/OrdemServico.Web.csproj OrdemServico.Web/
RUN dotnet restore OrdemServico.sln

# Copia o resto do c√≥digo e publica
COPY . .
WORKDIR /src/OrdemServico.Web
RUN dotnet publish -c Release -o /app/publish

# ===============================
# üöÄ STAGE 3: Runtime
# ===============================
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS final
WORKDIR /app

# Copia publica√ß√£o do .NET
COPY --from=build /app/publish .

# Copia build do React para o wwwroot da aplica√ß√£o ASP.NET
COPY --from=frontend-build /src/ClientApp/build ./wwwroot

# Seguran√ßa: usa usu√°rio sem privil√©gios
RUN useradd -m -s /bin/bash appuser
USER appuser

EXPOSE 8080
ENTRYPOINT ["dotnet", "OrdemServico.Web.dll"]
